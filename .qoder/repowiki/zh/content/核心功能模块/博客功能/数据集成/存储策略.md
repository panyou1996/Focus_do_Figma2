# 博客功能存储架构设计文档

<cite>
**本文档引用的文件**
- [STORAGE_SETUP_GUIDE.md](file://STORAGE_SETUP_GUIDE.md)
- [supabase_storage_setup.sql](file://supabase_storage_setup.sql)
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts)
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx)
- [src/utils/nativeService.ts](file://src/utils/nativeService.ts)
- [src/utils/supabase/client.ts](file://src/utils/supabase/client.ts)
- [src/utils/supabase/info.tsx](file://src/utils/supabase/info.tsx)
- [src/components/BlogComponents.tsx](file://src/components/BlogComponents.tsx)
- [src/types/checkin.ts](file://src/types/checkin.ts)
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql)
</cite>

## 目录
1. [概述](#概述)
2. [存储架构总览](#存储架构总览)
3. [本地缓存机制](#本地缓存机制)
4. [远程数据库同步](#远程数据库同步)
5. [图片存储与CDN集成](#图片存储与cdn集成)
6. [离线优先设计](#离线优先设计)
7. [数据同步策略](#数据同步策略)
8. [冲突解决机制](#冲突解决机制)
9. [性能优化](#性能优化)
10. [故障排除指南](#故障排除指南)

## 概述

本系统采用混合存储架构，结合本地缓存和远程数据库的优势，为博客功能提供完整的数据持久化解决方案。该架构支持离线操作，确保用户在无网络环境下也能正常使用应用，并在网络恢复时自动同步数据。

## 存储架构总览

```mermaid
graph TB
subgraph "客户端层"
A[React组件] --> B[CheckinService]
B --> C[DataService]
C --> D[NativeService]
end
subgraph "本地存储层"
E[LocalStorage] --> F[IndexedDB]
F --> G[Capacitor Storage]
end
subgraph "云端存储层"
H[Supabase Postgres] --> I[Supabase Storage]
I --> J[CDN]
end
B -.-> E
C -.-> E
B --> H
I --> J
style A fill:#e1f5fe
style B fill:#f3e5f5
style C fill:#e8f5e8
style D fill:#fff3e0
style E fill:#ffebee
style F fill:#e8f5e8
style G fill:#e3f2fd
style H fill:#f5f5f5
style I fill:#ffecb3
style J fill:#c8e6c9
```

**图表来源**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L1-L50)
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L1-L100)

## 本地缓存机制

### 缓存层次结构

系统采用多层缓存策略，确保数据的高效访问和持久化：

```mermaid
classDiagram
class CacheLayer {
+checkinItems : CheckinItem[]
+checkinRecords : CheckinRecord[]
+blogs : CheckinBlog[]
+lastSyncTime : Date
+clearCache() void
+getLastSyncTime() Date
}
class LocalStorage {
+getItem(key : string) string
+setItem(key : string, value : string) void
+removeItem(key : string) void
+clear() void
}
class IndexedDB {
+open() IDBDatabase
+transaction() IDBTransaction
+store() IDBObjectStore
}
class CapacitorStorage {
+get(key : string) StorageValue
+set(key : string, value : string) void
+remove(key : string) void
+clear() void
}
CacheLayer --> LocalStorage : "使用"
LocalStorage --> IndexedDB : "底层实现"
LocalStorage --> CapacitorStorage : "移动端"
```

**图表来源**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L15-L25)
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L60-L90)

### 缓存策略

1. **智能缓存更新**：当从远程获取数据时，自动更新本地缓存
2. **增量同步**：只同步发生变化的数据，减少网络传输
3. **缓存失效**：基于时间戳的缓存失效机制
4. **内存缓存**：在内存中维护最近使用的数据副本

**章节来源**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L40-L80)
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L120-L180)

## 远程数据库同步

### 数据库架构设计

```mermaid
erDiagram
USERS {
uuid id PK
string email
jsonb user_metadata
timestamp created_at
timestamp updated_at
}
CHECKIN_ITEMS {
bigint id PK
string title
text description
string icon
string color
string category
string target_type
integer target_count
uuid user_id FK
boolean is_active
timestamp created_at
timestamp updated_at
}
CHECKIN_RECORDS {
bigint id PK
bigint checkin_item_id FK
uuid user_id FK
timestamp checked_at
text note
string mood
string location
text photo_url
timestamp created_at
}
CHECKIN_BLOGS {
bigint id PK
string title
text content
text cover_image_url
string location
text[] tags
bigint[] checkin_records
string mood
string weather
uuid user_id FK
boolean is_public
integer like_count
integer view_count
timestamp created_at
timestamp updated_at
}
USERS ||--o{ CHECKIN_ITEMS : "owns"
USERS ||--o{ CHECKIN_RECORDS : "generates"
USERS ||--o{ CHECKIN_BLOGS : "writes"
CHECKIN_ITEMS ||--o{ CHECKIN_RECORDS : "triggers"
```

**图表来源**
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql#L1-L50)
- [src/types/checkin.ts](file://src/types/checkin.ts#L1-L50)

### 同步机制

系统实现了双向同步机制，确保本地和远程数据的一致性：

```mermaid
sequenceDiagram
participant Client as "客户端应用"
participant LocalCache as "本地缓存"
participant RemoteDB as "远程数据库"
participant Storage as "对象存储"
Client->>LocalCache : 读取数据
LocalCache-->>Client : 返回缓存数据
Client->>LocalCache : 写入本地数据
LocalCache->>RemoteDB : 异步同步请求
RemoteDB-->>LocalCache : 确认同步
Client->>Storage : 上传图片
Storage-->>Client : 返回图片URL
Note over Client,Storage : 网络恢复时批量同步
Client->>RemoteDB : 批量同步待处理变更
RemoteDB-->>Client : 同步完成确认
```

**图表来源**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L600-L650)
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L750-L800)

**章节来源**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L200-L300)
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql#L100-L200)

## 图片存储与CDN集成

### 对象存储配置

系统使用Supabase Storage作为图片存储解决方案，支持CDN加速和全球分发：

```mermaid
flowchart TD
A[图片上传请求] --> B{验证文件类型}
B --> |有效| C[生成唯一文件名]
B --> |无效| D[返回错误]
C --> E[上传到Supabase Storage]
E --> F{上传成功?}
F --> |是| G[生成CDN URL]
F --> |否| H[处理上传错误]
G --> I[返回公共访问URL]
H --> J[提供错误指导]
I --> K[更新博客记录]
J --> L[显示用户友好的错误消息]
```

**图表来源**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L600-L650)
- [STORAGE_SETUP_GUIDE.md](file://STORAGE_SETUP_GUIDE.md#L1-L30)

### 存储策略配置

根据STORAGE_SETUP_GUIDE.md中的配置，系统使用以下RLS策略：

1. **上传策略**：允许认证用户上传图片到images桶
2. **访问策略**：允许所有人查看公共图片
3. **删除策略**：允许用户删除自己的图片

**章节来源**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L600-L680)
- [supabase_storage_setup.sql](file://supabase_storage_setup.sql#L1-L42)

## 离线优先设计

### 离线数据管理

系统采用离线优先的设计理念，确保用户在任何网络状态下都能正常使用应用：

```mermaid
stateDiagram-v2
[*] --> Online
Online --> Offline : 网络断开
Offline --> Online : 网络恢复
Online --> Online : 数据同步
Offline --> Offline : 离线操作
state Online {
[*] --> ReadFromRemote
ReadFromRemote --> WriteToLocal
WriteToLocal --> SyncToRemote
SyncToRemote --> [*]
}
state Offline {
[*] --> ReadFromCache
ReadFromCache --> WriteToCache
WriteToCache --> [*]
}
```

**图表来源**
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L30-L60)
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L15-L45)

### 离线功能支持

1. **离线数据创建**：用户可以在离线状态下创建新的博客
2. **本地数据缓存**：所有操作都先写入本地缓存
3. **待同步队列**：记录所有待同步的操作
4. **网络恢复检测**：自动检测网络状态变化

**章节来源**
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L200-L300)
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L700-L736)

## 数据同步策略

### 同步流程设计

```mermaid
flowchart TD
A[检测网络状态] --> B{是否在线?}
B --> |否| C[等待网络恢复]
B --> |是| D[检查待同步数据]
D --> E{有待同步数据?}
E --> |否| F[结束同步]
E --> |是| G[开始同步循环]
G --> H[同步个人资料更新]
H --> I[同步任务创建]
I --> J[同步任务更新]
J --> K[同步任务删除]
K --> L[获取最新数据]
L --> M[清除同步队列]
M --> F
C --> A
```

**图表来源**
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L750-L830)

### 同步优先级

系统为不同类型的操作设置不同的同步优先级：

1. **高优先级**：用户认证状态变更
2. **中优先级**：个人资料更新
3. **低优先级**：普通任务操作

**章节来源**
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L750-L830)

## 冲突解决机制

### 时间戳优先策略

当出现数据冲突时，系统采用时间戳优先的策略：

```mermaid
flowchart LR
A[本地数据] --> C{比较时间戳}
B[远程数据] --> C
C --> |本地更新较新| D[保留本地数据]
C --> |远程更新较新| E[覆盖本地数据]
C --> |时间戳相同| F[用户选择]
F --> G[弹出选择对话框]
G --> H[用户确认]
H --> I[应用用户选择]
```

**图表来源**
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L200-L250)

### 冲突检测与处理

1. **自动检测**：系统自动检测数据版本冲突
2. **用户交互**：对于无法自动解决的冲突，提供用户选择界面
3. **历史记录**：保留冲突解决的历史记录

**章节来源**
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L200-L280)

## 性能优化

### 查询优化策略

1. **索引优化**：为常用查询字段创建复合索引
2. **查询缓存**：缓存频繁查询的结果
3. **分页加载**：大数据集采用分页加载策略
4. **懒加载**：图片等资源采用懒加载

### 缓存优化

```mermaid
graph LR
A[用户请求] --> B{缓存命中?}
B --> |是| C[返回缓存数据]
B --> |否| D[查询数据库]
D --> E[更新缓存]
E --> F[返回数据]
C --> G[更新访问时间]
G --> H[定期清理过期缓存]
```

**图表来源**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L40-L80)

**章节来源**
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql#L50-L100)

## 故障排除指南

### 常见存储问题

1. **存储桶未创建**
   - 错误信息：`Storage bucket "images" not found`
   - 解决方案：在Supabase控制台创建images存储桶

2. **权限不足**
   - 错误信息：`Permission denied`
   - 解决方案：检查RLS策略配置

3. **网络超时**
   - 错误信息：`Timeout error`
   - 解决方案：检查网络连接和数据库性能

### 监控与诊断

系统提供了完整的监控机制：

```mermaid
flowchart TD
A[应用启动] --> B[检查存储桶]
B --> C{存储桶存在?}
C --> |否| D[显示设置指导]
C --> |是| E[检查RLS策略]
E --> F{策略正确?}
F --> |否| G[显示策略错误]
F --> |是| H[初始化完成]
D --> I[用户手动设置]
G --> J[管理员修复策略]
I --> H
J --> H
```

**图表来源**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L600-L650)

**章节来源**
- [STORAGE_SETUP_GUIDE.md](file://STORAGE_SETUP_GUIDE.md#L1-L80)
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L600-L680)

## 结论

本存储架构设计充分考虑了现代移动应用的需求，通过合理的缓存策略、同步机制和冲突解决方案，为博客功能提供了稳定可靠的数据存储解决方案。该架构不仅支持离线操作，还能在恢复网络连接后自动同步数据，确保用户体验的一致性和数据的完整性。