# æ•°æ®åº“è®¾è®¡æ–‡æ¡£

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [supabase_step1_tables.sql](file://supabase_step1_tables.sql)
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql)
- [supabase_step2_indexes.sql](file://supabase_step2_indexes.sql)
- [supabase_storage_setup.sql](file://supabase_storage_setup.sql)
- [src/types/checkin.ts](file://src/types/checkin.ts)
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts)
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx)
- [src/components/CheckinPage.tsx](file://src/components/CheckinPage.tsx)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„æ¦‚è¿°](#é¡¹ç›®ç»“æ„æ¦‚è¿°)
3. [æ ¸å¿ƒæ•°æ®è¡¨è®¾è®¡](#æ ¸å¿ƒæ•°æ®è¡¨è®¾è®¡)
4. [æ•°æ®åº“æ¶æ„æ¦‚è§ˆ](#æ•°æ®åº“æ¶æ„æ¦‚è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ç´¢å¼•ä¼˜åŒ–ç­–ç•¥](#ç´¢å¼•ä¼˜åŒ–ç­–ç•¥)
7. [è¡Œçº§å®‰å…¨ç­–ç•¥](#è¡Œçº§å®‰å…¨ç­–ç•¥)
8. [å­˜å‚¨æ¡¶é…ç½®](#å­˜å‚¨æ¡¶é…ç½®)
9. [å‰åç«¯æ•°æ®æ¨¡å‹ä¸€è‡´æ€§](#å‰åç«¯æ•°æ®æ¨¡å‹ä¸€è‡´æ€§)
10. [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)
11. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
12. [ç»“è®º](#ç»“è®º)

## ç®€ä»‹

æœ¬æ–‡æ¡£åŸºäºFocus.doåº”ç”¨ç¨‹åºçš„æ•°æ®åº“è®¾è®¡ï¼Œè¯¦ç»†æè¿°äº†Supabaseæ•°æ®åº“çš„å®Œæ•´æ¶æ„ã€‚è¯¥ç³»ç»Ÿé‡‡ç”¨PostgreSQLä½œä¸ºåº•å±‚æ•°æ®åº“ï¼Œç»“åˆSupabaseå¹³å°æä¾›çš„åŠŸèƒ½ï¼Œæ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„æ‰“å¡ï¼ˆCheck-inï¼‰åŠŸèƒ½ç”Ÿæ€ç³»ç»Ÿã€‚æ•°æ®åº“è®¾è®¡éµå¾ªç°ä»£åŒ–çš„NoSQLå’ŒSQLæ··åˆæ¶æ„ç†å¿µï¼Œé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ•°æ®è¡¨ç»“æ„ã€ç´¢å¼•ç­–ç•¥å’Œå®‰å…¨ç­–ç•¥ï¼Œä¸ºç”¨æˆ·æä¾›é«˜æ•ˆã€å®‰å…¨çš„æ‰“å¡ä½“éªŒã€‚

## é¡¹ç›®ç»“æ„æ¦‚è¿°

Focus.doåº”ç”¨ç¨‹åºé‡‡ç”¨äº†æ¨¡å—åŒ–çš„æ•°æ®åº“è®¾è®¡ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

```mermaid
graph TB
subgraph "æ•°æ®åº“éƒ¨ç½²é˜¶æ®µ"
A[ç¬¬ä¸€æ­¥ï¼šåŸºç¡€è¡¨ç»“æ„]
B[ç¬¬äºŒæ­¥ï¼šç´¢å¼•å’Œè§†å›¾]
C[ç¬¬ä¸‰æ­¥ï¼šå­˜å‚¨æ¡¶é…ç½®]
end
subgraph "æ ¸å¿ƒåŠŸèƒ½æ¨¡å—"
D[æ‰“å¡é¡¹ç›®ç®¡ç†]
E[æ‰“å¡è®°å½•è¿½è¸ª]
F[åšå®¢å†…å®¹ç®¡ç†]
G[ç”¨æˆ·æƒé™æ§åˆ¶]
end
A --> D
A --> E
A --> F
B --> D
B --> E
B --> F
C --> F
G --> D
G --> E
G --> F
```

**å›¾è¡¨æ¥æº**
- [supabase_step1_tables.sql](file://supabase_step1_tables.sql#L1-L62)
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql#L1-L284)

**ç« èŠ‚æ¥æº**
- [supabase_step1_tables.sql](file://supabase_step1_tables.sql#L1-L62)
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql#L1-L284)

## æ ¸å¿ƒæ•°æ®è¡¨è®¾è®¡

### æ‰“å¡é¡¹ç›®è¡¨ (checkin_items)

æ‰“å¡é¡¹ç›®è¡¨æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£å­˜å‚¨ç”¨æˆ·åˆ›å»ºçš„å„ç§æ‰“å¡é¡¹ç›®ä¿¡æ¯ã€‚

```sql
CREATE TABLE IF NOT EXISTS checkin_items (
  id BIGSERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  icon VARCHAR(10) DEFAULT 'ğŸ“',
  color VARCHAR(7) DEFAULT '#6B7280',
  category VARCHAR(20) NOT NULL DEFAULT 'other',
  target_type VARCHAR(10) NOT NULL DEFAULT 'daily',
  target_count INTEGER DEFAULT 1,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  is_active BOOLEAN DEFAULT true,
  
  CONSTRAINT valid_category CHECK (category IN ('health', 'fitness', 'learning', 'habit', 'work', 'hobby', 'social', 'other')),
  CONSTRAINT valid_target_type CHECK (target_type IN ('daily', 'weekly', 'custom')),
  CONSTRAINT valid_target_count CHECK (target_count > 0)
);
```

**å…³é”®ç‰¹æ€§ï¼š**
- **å”¯ä¸€æ ‡è¯†ç¬¦**ï¼šä½¿ç”¨BIGSERIALè‡ªå¢ä¸»é”®ç¡®ä¿æ¯ä¸ªé¡¹ç›®çš„å”¯ä¸€æ€§
- **åˆ†ç±»ç³»ç»Ÿ**ï¼šæ”¯æŒ8ç§é¢„å®šä¹‰åˆ†ç±»ï¼Œä¾¿äºç”¨æˆ·ç»„ç»‡å’ŒæŸ¥æ‰¾
- **ç›®æ ‡è®¾å®š**ï¼šæ”¯æŒæ¯æ—¥ã€æ¯å‘¨æˆ–è‡ªå®šä¹‰ç›®æ ‡ç±»å‹
- **è§†è§‰å®šåˆ¶**ï¼šå…è®¸ç”¨æˆ·è‡ªå®šä¹‰å›¾æ ‡å’Œé¢œè‰²ä¸»é¢˜
- **è½¯åˆ é™¤**ï¼šé€šè¿‡is_activeå­—æ®µå®ç°é€»è¾‘åˆ é™¤è€Œéç‰©ç†åˆ é™¤

### æ‰“å¡è®°å½•è¡¨ (checkin_records)

æ‰“å¡è®°å½•è¡¨è·Ÿè¸ªç”¨æˆ·çš„å®é™…æ‰“å¡è¡Œä¸ºï¼Œæ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®å­˜å‚¨ã€‚

```sql
CREATE TABLE IF NOT EXISTS checkin_records (
  id BIGSERIAL PRIMARY KEY,
  checkin_item_id BIGINT REFERENCES checkin_items(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  checked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  note TEXT,
  mood VARCHAR(20),
  location VARCHAR(255),
  photo_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  CONSTRAINT valid_mood CHECK (mood IN ('excellent', 'good', 'neutral', 'tired', 'stressed') OR mood IS NULL)
);
```

**å…³é”®ç‰¹æ€§ï¼š**
- **å…³è”å…³ç³»**ï¼šä¸checkin_itemså»ºç«‹å¤–é”®å…³ç³»ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
- **å¤šç»´åº¦è®°å½•**ï¼šæ”¯æŒå¤‡æ³¨ã€å¿ƒæƒ…ã€ä½ç½®å’Œç…§ç‰‡ç­‰å¤šç§è®°å½•å½¢å¼
- **æ—¶é—´æˆ³ç®¡ç†**ï¼šè‡ªåŠ¨è®°å½•åˆ›å»ºæ—¶é—´å’Œæ‰“å¡æ—¶é—´
- **çµæ´»çš„å¿ƒæƒ…ç³»ç»Ÿ**ï¼šæ”¯æŒ5ç§é¢„å®šä¹‰å¿ƒæƒ…çŠ¶æ€

### åšå®¢è¡¨ (checkin_blogs)

åšå®¢è¡¨ä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªåˆ†äº«æ‰“å¡ä½“éªŒçš„ç©ºé—´ï¼Œæ”¯æŒå¯Œæ–‡æœ¬å†…å®¹å’Œå¤šåª’ä½“å±•ç¤ºã€‚

```sql
CREATE TABLE IF NOT EXISTS checkin_blogs (
  id BIGSERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  cover_image_url TEXT,
  location VARCHAR(255),
  tags TEXT[] DEFAULT '{}',
  checkin_records BIGINT[] DEFAULT '{}',
  mood VARCHAR(20) NOT NULL DEFAULT 'neutral',
  weather VARCHAR(100),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  is_public BOOLEAN DEFAULT false,
  like_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  
  CONSTRAINT valid_mood CHECK (mood IN ('excellent', 'good', 'neutral', 'tired', 'stressed')),
  CONSTRAINT valid_like_count CHECK (like_count >= 0),
  CONSTRAINT valid_view_count CHECK (view_count >= 0)
);
```

**å…³é”®ç‰¹æ€§ï¼š**
- **æ•°ç»„å­—æ®µ**ï¼štagså’Œcheckin_recordsä½¿ç”¨PostgreSQLæ•°ç»„ç±»å‹ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
- **å¤šåª’ä½“æ”¯æŒ**ï¼šæ”¯æŒå°é¢å›¾ç‰‡å’Œå…³è”çš„æ‰“å¡è®°å½•
- **ç¤¾äº¤åŠŸèƒ½**ï¼šå†…ç½®ç‚¹èµå’Œæµè§ˆè®¡æ•°åŠŸèƒ½
- **éšç§æ§åˆ¶**ï¼šé€šè¿‡is_publicå­—æ®µæ§åˆ¶å†…å®¹å¯è§æ€§

**ç« èŠ‚æ¥æº**
- [supabase_step1_tables.sql](file://supabase_step1_tables.sql#L1-L62)
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql#L1-L284)

## æ•°æ®åº“æ¶æ„æ¦‚è§ˆ

```mermaid
erDiagram
AUTH_USERS {
uuid id PK
text email
jsonb user_metadata
timestamp created_at
timestamp updated_at
}
CHECKIN_ITEMS {
bigint id PK
varchar title
text description
varchar icon
varchar color
varchar category
varchar target_type
integer target_count
timestamp created_at
timestamp updated_at
uuid user_id FK
boolean is_active
}
CHECKIN_RECORDS {
bigint id PK
bigint checkin_item_id FK
uuid user_id FK
timestamp checked_at
text note
varchar mood
varchar location
text photo_url
timestamp created_at
}
CHECKIN_BLOGS {
bigint id PK
varchar title
text content
text cover_image_url
varchar location
text_array tags
bigint_array checkin_records
varchar mood
varchar weather
timestamp created_at
timestamp updated_at
uuid user_id FK
boolean is_public
integer like_count
integer view_count
}
AUTH_USERS ||--o{ CHECKIN_ITEMS : "owns"
AUTH_USERS ||--o{ CHECKIN_RECORDS : "creates"
AUTH_USERS ||--o{ CHECKIN_BLOGS : "writes"
CHECKIN_ITEMS ||--o{ CHECKIN_RECORDS : "generates"
CHECKIN_ITEMS ||--o{ CHECKIN_BLOGS : "inspires"
```

**å›¾è¡¨æ¥æº**
- [supabase_step1_tables.sql](file://supabase_step1_tables.sql#L1-L62)
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql#L1-L284)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### æ‰“å¡é¡¹ç›®ç®¡ç†ç»„ä»¶

æ‰“å¡é¡¹ç›®ç®¡ç†æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·çš„æ‰€æœ‰æ‰“å¡é¡¹ç›®ç”Ÿå‘½å‘¨æœŸã€‚

```mermaid
sequenceDiagram
participant User as "ç”¨æˆ·"
participant Frontend as "å‰ç«¯ç»„ä»¶"
participant Service as "CheckinService"
participant DB as "æ•°æ®åº“"
participant Cache as "ç¼“å­˜å±‚"
User->>Frontend : åˆ›å»ºæ–°æ‰“å¡é¡¹ç›®
Frontend->>Service : createCheckinItem()
Service->>Service : éªŒè¯ç”¨æˆ·èº«ä»½
Service->>DB : æ’å…¥checkin_itemsè®°å½•
DB-->>Service : è¿”å›æ–°é¡¹ç›®æ•°æ®
Service->>Cache : æ›´æ–°æœ¬åœ°ç¼“å­˜
Service-->>Frontend : è¿”å›é¡¹ç›®å¯¹è±¡
Frontend-->>User : æ˜¾ç¤ºæ–°é¡¹ç›®
User->>Frontend : æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨
Frontend->>Service : getCheckinItems()
Service->>Cache : æ£€æŸ¥ç¼“å­˜
Cache-->>Service : ç¼“å­˜æœªå‘½ä¸­
Service->>DB : æŸ¥è¯¢æ´»è·ƒé¡¹ç›®
DB-->>Service : è¿”å›é¡¹ç›®åˆ—è¡¨
Service->>Cache : æ›´æ–°ç¼“å­˜
Service-->>Frontend : è¿”å›é¡¹ç›®åˆ—è¡¨
Frontend-->>User : æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
```

**å›¾è¡¨æ¥æº**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L1-L199)
- [src/components/CheckinPage.tsx](file://src/components/CheckinPage.tsx#L1-L199)

### æ‰“å¡è®°å½•è¿½è¸ªç»„ä»¶

æ‰“å¡è®°å½•è¿½è¸ªç³»ç»Ÿè´Ÿè´£è®°å½•ç”¨æˆ·çš„å®é™…æ‰“å¡è¡Œä¸ºï¼Œå¹¶æä¾›ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

```mermaid
flowchart TD
Start([ç”¨æˆ·æ‰“å¡]) --> ValidateItem["éªŒè¯æ‰“å¡é¡¹ç›®"]
ValidateItem --> CheckExisting["æ£€æŸ¥å½“å¤©æ˜¯å¦å·²æ‰“å¡"]
CheckExisting --> HasRecord{"å·²æœ‰è®°å½•?"}
HasRecord --> |æ˜¯| UpdateRecord["æ›´æ–°ç°æœ‰è®°å½•"]
HasRecord --> |å¦| CreateRecord["åˆ›å»ºæ–°è®°å½•"]
CreateRecord --> AddContext["æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯"]
UpdateRecord --> AddContext
AddContext --> SaveToDB["ä¿å­˜åˆ°æ•°æ®åº“"]
SaveToDB --> UpdateStats["æ›´æ–°ç»Ÿè®¡ä¿¡æ¯"]
UpdateStats --> NotifyUser["é€šçŸ¥ç”¨æˆ·"]
NotifyUser --> End([å®Œæˆ])
```

**å›¾è¡¨æ¥æº**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L174-L219)

### åšå®¢ç®¡ç†ç³»ç»Ÿ

åšå®¢ç³»ç»Ÿä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªåˆ†äº«æ‰“å¡ä½“éªŒçš„å¹³å°ï¼Œæ”¯æŒå¤šç§å†…å®¹å½¢å¼å’Œç¤¾äº¤äº’åŠ¨ã€‚

```mermaid
classDiagram
class CheckinBlog {
+number|string id
+string title
+string content
+string cover_image_url
+string location
+string[] tags
+number[] checkin_records
+CheckinMood mood
+string weather
+Date created_at
+Date updated_at
+string user_id
+boolean is_public
+number like_count
+number view_count
+likeBlog() Promise~void~
+shareBlog() Promise~string~
+commentOnBlog() Promise~void~
}
class BlogFilters {
+CheckinMood mood
+string[] tags
+string location
+DateRange dateRange
+string sortBy
+string sortOrder
}
class CheckinService {
+getBlogs(filters) Promise~CheckinBlog[]~
+getBlogById(id) Promise~CheckinBlog~
+createBlog(blog) Promise~CheckinBlog~
+updateBlog(id, updates) Promise~CheckinBlog~
+deleteBlog(id) Promise~void~
+likeBlog(id) Promise~void~
}
CheckinService --> CheckinBlog : "manages"
CheckinBlog --> BlogFilters : "filtered by"
CheckinService --> BlogFilters : "uses"
```

**å›¾è¡¨æ¥æº**
- [src/types/checkin.ts](file://src/types/checkin.ts#L1-L284)
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L1-L199)

**ç« èŠ‚æ¥æº**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L1-L199)
- [src/types/checkin.ts](file://src/types/checkin.ts#L1-L284)

## ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

ä¸ºäº†ç¡®ä¿ç³»ç»Ÿçš„é«˜æ€§èƒ½ï¼Œæ•°æ®åº“è®¾è®¡ä¸­åŒ…å«äº†ç²¾å¿ƒè®¾è®¡çš„ç´¢å¼•ç­–ç•¥ã€‚

### ä¸»è¦ç´¢å¼•ç»“æ„

```sql
-- æ‰“å¡é¡¹ç›®ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_checkin_items_user_id ON checkin_items(user_id);
CREATE INDEX IF NOT EXISTS idx_checkin_items_category ON checkin_items(category);
CREATE INDEX IF NOT EXISTS idx_checkin_items_active ON checkin_items(is_active);

-- æ‰“å¡è®°å½•ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_checkin_records_user_id ON checkin_records(user_id);
CREATE INDEX IF NOT EXISTS idx_checkin_records_item_id ON checkin_records(checkin_item_id);
CREATE INDEX IF NOT EXISTS idx_checkin_records_checked_at ON checkin_records(checked_at);
CREATE INDEX IF NOT EXISTS idx_checkin_records_mood ON checkin_records(mood);

-- Blogç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_checkin_blogs_user_id ON checkin_blogs(user_id);
CREATE INDEX IF NOT EXISTS idx_checkin_blogs_created_at ON checkin_blogs(created_at);
CREATE INDEX IF NOT EXISTS idx_checkin_blogs_mood ON checkin_blogs(mood);
CREATE INDEX IF NOT EXISTS idx_checkin_blogs_tags ON checkin_blogs USING GIN(tags);
CREATE INDEX IF NOT EXISTS idx_checkin_blogs_public ON checkin_blogs(is_public);
```

### ç´¢å¼•ä¼˜åŒ–åŸç†

```mermaid
graph LR
subgraph "æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥"
A[å•å­—æ®µç´¢å¼•] --> A1[user_id]
A --> A2[category]
A --> A3[checked_at]
B[å¤åˆç´¢å¼•] --> B1[user_id + category]
B --> B2[user_id + checked_at]
C[GINç´¢å¼•] --> C1[tagsæ•°ç»„]
D[æ¡ä»¶è¿‡æ»¤] --> D1[is_active=true]
D --> D2[is_public=true]
end
```

**å›¾è¡¨æ¥æº**
- [supabase_step2_indexes.sql](file://supabase_step2_indexes.sql#L1-L54)

**ç« èŠ‚æ¥æº**
- [supabase_step2_indexes.sql](file://supabase_step2_indexes.sql#L1-L54)

## è¡Œçº§å®‰å…¨ç­–ç•¥

Supabaseçš„è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰ç­–ç•¥ç¡®ä¿äº†æ•°æ®çš„å®‰å…¨æ€§å’Œéšç§ä¿æŠ¤ã€‚

### æ‰“å¡é¡¹ç›®RLSç­–ç•¥

```sql
-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„æ‰“å¡é¡¹ç›®
CREATE POLICY "Users can view their own checkin items" 
  ON checkin_items FOR SELECT 
  USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ’å…¥è‡ªå·±çš„æ‰“å¡é¡¹ç›®
CREATE POLICY "Users can insert their own checkin items" 
  ON checkin_items FOR INSERT 
  WITH CHECK (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„æ‰“å¡é¡¹ç›®
CREATE POLICY "Users can update their own checkin items" 
  ON checkin_items FOR UPDATE 
  USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„æ‰“å¡é¡¹ç›®
CREATE POLICY "Users can delete their own checkin items" 
  ON checkin_items FOR DELETE 
  USING (auth.uid() = user_id);
```

### åšå®¢RLSç­–ç•¥

```sql
-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„åšå®¢å’Œå…¬å¼€çš„åšå®¢
CREATE POLICY "Users can view their own blogs and public blogs" 
  ON checkin_blogs FOR SELECT 
  USING (auth.uid() = user_id OR is_public = true);

-- ç”¨æˆ·å¯ä»¥æ’å…¥è‡ªå·±çš„åšå®¢
CREATE POLICY "Users can insert their own blogs" 
  ON checkin_blogs FOR INSERT 
  WITH CHECK (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„åšå®¢
CREATE POLICY "Users can update their own blogs" 
  ON checkin_blogs FOR UPDATE 
  USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„åšå®¢
CREATE POLICY "Users can delete their own blogs" 
  ON checkin_blogs FOR DELETE 
  USING (auth.uid() = user_id);
```

**ç« èŠ‚æ¥æº**
- [supabase_checkin_tables.sql](file://supabase_checkin_tables.sql#L130-L200)

## å­˜å‚¨æ¡¶é…ç½®

### å›¾ç‰‡å­˜å‚¨æ¡¶è®¾ç½®

```sql
-- æ’å…¥imageså­˜å‚¨æ¡¶
INSERT INTO storage.buckets (id, name, public)
VALUES ('images', 'images', true)
ON CONFLICT (id) DO UPDATE SET
  name = EXCLUDED.name,
  public = EXCLUDED.public;
```

### å­˜å‚¨ç­–ç•¥é…ç½®

```mermaid
graph TB
subgraph "å­˜å‚¨ç­–ç•¥é…ç½®"
A[imageså­˜å‚¨æ¡¶] --> B[å…è®¸è®¤è¯ç”¨æˆ·ä¸Šä¼ ]
A --> C[å…è®¸æ‰€æœ‰äººæŸ¥çœ‹]
A --> D[å…è®¸ç”¨æˆ·åˆ é™¤è‡ªå·±çš„å›¾ç‰‡]
B --> B1[Policy: Allow authenticated users to upload images]
C --> C1[Policy: Allow public to view images]
D --> D1[Policy: Allow users to delete own images]
end
```

**å›¾è¡¨æ¥æº**
- [supabase_storage_setup.sql](file://supabase_storage_setup.sql#L1-L42)

**ç« èŠ‚æ¥æº**
- [supabase_storage_setup.sql](file://supabase_storage_setup.sql#L1-L42)

## å‰åç«¯æ•°æ®æ¨¡å‹ä¸€è‡´æ€§

### TypeScriptæ¥å£å®šä¹‰

ç³»ç»Ÿé‡‡ç”¨äº†å¼ºç±»å‹çš„TypeScriptæ¥å£æ¥ç¡®ä¿å‰åç«¯æ•°æ®æ¨¡å‹çš„ä¸€è‡´æ€§ã€‚

```typescript
// æ‰“å¡é¡¹ç›®ç±»å‹
export interface CheckinItem {
  id: number | string;
  title: string;
  description?: string;
  icon: string;
  color: string;
  category: CheckinCategory;
  target_type: 'daily' | 'weekly' | 'custom';
  target_count: number;
  created_at: Date;
  updated_at: Date;
  user_id: string;
  is_active: boolean;
}

// å¿ƒæƒ…çŠ¶æ€æšä¸¾
export type CheckinMood = 
  | 'excellent'   // ğŸ˜„
  | 'good'        // ğŸ˜Š
  | 'neutral'     // ğŸ˜
  | 'tired'       // ğŸ˜´
  | 'stressed';   // ğŸ˜°

// åšå®¢æ–‡ç« æ¥å£
export interface CheckinBlog {
  id: number | string;
  title: string;
  content: string;
  cover_image_url?: string;
  location?: string;
  tags: string[];
  checkin_records: number[];
  mood: CheckinMood;
  weather?: string;
  created_at: Date;
  updated_at: Date;
  user_id: string;
  is_public: boolean;
  like_count: number;
  view_count: number;
}
```

### æ•°æ®è½¬æ¢æ˜ å°„

```mermaid
flowchart LR
subgraph "æ•°æ®åº“å­—æ®µ"
A[id] --> A1[bigint]
B[title] --> B1[varchar]
C[content] --> C1[text]
D[tags] --> D1[text_array]
end
subgraph "TypeScriptæ¥å£"
E[id] --> E1[number|string]
F[title] --> F1[string]
G[content] --> G1[string]
H[tags] --> H1[string[]]
end
A1 -.-> E1
B1 -.-> F1
C1 -.-> G1
D1 -.-> H1
```

**å›¾è¡¨æ¥æº**
- [src/types/checkin.ts](file://src/types/checkin.ts#L1-L284)

**ç« èŠ‚æ¥æº**
- [src/types/checkin.ts](file://src/types/checkin.ts#L1-L284)

## æ€§èƒ½è€ƒè™‘

### ç¼“å­˜ç­–ç•¥

ç³»ç»Ÿå®ç°äº†å¤šå±‚æ¬¡çš„ç¼“å­˜æœºåˆ¶æ¥æå‡æ€§èƒ½ï¼š

```typescript
private cache = {
  checkinItems: [] as CheckinItem[],
  checkinRecords: [] as CheckinRecord[],
  blogs: [] as CheckinBlog[],
  lastSyncTime: null as Date | null
};
```

### æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

1. **æ‰¹é‡æŸ¥è¯¢**ï¼šä½¿ç”¨Promise.allSettledå¹¶è¡ŒåŠ è½½å¤šä¸ªæ•°æ®æº
2. **æ¡ä»¶æŸ¥è¯¢**ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥åŠ¨æ€æ„å»ºæŸ¥è¯¢æ¡ä»¶
3. **åˆ†é¡µå¤„ç†**ï¼šå¯¹å¤§é‡æ•°æ®è¿›è¡Œåˆ†é¡µå¤„ç†
4. **ç´¢å¼•åˆ©ç”¨**ï¼šå……åˆ†åˆ©ç”¨æ•°æ®åº“ç´¢å¼•åŠ é€ŸæŸ¥è¯¢

### æ•°æ®åº“è¿æ¥ä¼˜åŒ–

```typescript
// è‡ªåŠ¨åˆ·æ–°ä»¤ç‰Œ
auth: {
  autoRefreshToken: true,
  persistSession: true,
  detectSessionInUrl: false
}
```

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **å­˜å‚¨æ¡¶ä¸å­˜åœ¨**
   - é”™è¯¯ä¿¡æ¯ï¼š`Storage bucket "images" not found`
   - è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨åˆ›å»ºimageså­˜å‚¨æ¡¶æˆ–æ‰§è¡Œå­˜å‚¨æ¡¶è®¾ç½®è„šæœ¬

2. **æƒé™ä¸è¶³**
   - é”™è¯¯ä¿¡æ¯ï¼š`401 Unauthorized`
   - è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€å’ŒRLSç­–ç•¥é…ç½®

3. **ç´¢å¼•ç¼ºå¤±**
   - æ€§èƒ½é—®é¢˜ï¼šæŸ¥è¯¢å“åº”ç¼“æ…¢
   - è§£å†³æ–¹æ¡ˆï¼šæ‰§è¡Œç´¢å¼•åˆ›å»ºè„šæœ¬

4. **æ•°æ®ç±»å‹ä¸åŒ¹é…**
   - ç±»å‹é”™è¯¯ï¼šæ•°æ®åº“å­—æ®µä¸TypeScriptæ¥å£ä¸ä¸€è‡´
   - è§£å†³æ–¹æ¡ˆï¼šåŒæ­¥ä¿®æ”¹æ•°æ®åº“ç»“æ„å’ŒTypeScriptå®šä¹‰

### è°ƒè¯•å·¥å…·

```typescript
// å¯ç”¨è¯¦ç»†æ—¥å¿—
console.log('CheckinDataService initialized successfully');
console.error('Failed to fetch checkin items:', error);
```

**ç« èŠ‚æ¥æº**
- [src/utils/checkinService.ts](file://src/utils/checkinService.ts#L1-L199)
- [src/utils/dataService.tsx](file://src/utils/dataService.tsx#L1-L199)

## ç»“è®º

Focus.doåº”ç”¨ç¨‹åºçš„æ•°æ®åº“è®¾è®¡å±•ç°äº†ç°ä»£Webåº”ç”¨çš„æœ€ä½³å®è·µã€‚é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ•°æ®è¡¨ç»“æ„ã€å®Œå–„çš„ç´¢å¼•ç­–ç•¥ã€ä¸¥æ ¼çš„å®‰å…¨æ§åˆ¶å’Œé«˜æ•ˆçš„ç¼“å­˜æœºåˆ¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿä¸ºç”¨æˆ·æä¾›ç¨³å®šã€å¿«é€Ÿã€å®‰å…¨çš„æœåŠ¡ä½“éªŒã€‚

### è®¾è®¡äº®ç‚¹

1. **æ¨¡å—åŒ–æ¶æ„**ï¼šæ¸…æ™°çš„åŠŸèƒ½åˆ†ç¦»å’Œæ•°æ®æµè®¾è®¡
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤šå±‚æ¬¡çš„ç´¢å¼•å’Œç¼“å­˜ç­–ç•¥
3. **å®‰å…¨æ€§ä¿éšœ**ï¼šå®Œå–„çš„RLSç­–ç•¥å’Œæƒé™æ§åˆ¶
4. **æ‰©å±•æ€§è®¾è®¡**ï¼šæ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•çš„çµæ´»æ¶æ„
5. **å¼€å‘å‹å¥½**ï¼šå¼ºç±»å‹æ¥å£å’Œè¯¦ç»†çš„æ–‡æ¡£è¯´æ˜

### æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **åˆ†åŒºç­–ç•¥**ï¼šå¯¹äºå¤§è§„æ¨¡æ•°æ®ï¼Œè€ƒè™‘ä½¿ç”¨è¡¨åˆ†åŒº
2. **è¯»å†™åˆ†ç¦»**ï¼šå®ç°æ•°æ®åº“è¯»å†™åˆ†ç¦»ä»¥æå‡å¹¶å‘èƒ½åŠ›
3. **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„æ•°æ®åº“ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
4. **å¤‡ä»½æ¢å¤**ï¼šåˆ¶å®šå®šæœŸå¤‡ä»½å’Œç¾éš¾æ¢å¤è®¡åˆ’

è¿™å¥—æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆä¸ä»…æ»¡è¶³äº†å½“å‰çš„åŠŸèƒ½éœ€æ±‚ï¼Œä¹Ÿä¸ºæœªæ¥çš„ä¸šåŠ¡å¢é•¿å’ŒæŠ€æœ¯æ¼”è¿›å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚